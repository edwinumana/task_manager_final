# =============================================================================
# PIPELINE CI/CD PARA TASK MANAGER
# =============================================================================
# Este pipeline automatiza la construcciÃ³n, prueba y despliegue de la aplicaciÃ³n
# Task Manager usando GitHub Actions, Docker y Docker Hub.

name: ğŸš€ Task Manager CI/CD Pipeline

# Triggers del pipeline
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite ejecuciÃ³n manual

# Variables de entorno globales
env:
  DOCKER_IMAGE: task-manager
  DOCKER_HUB_REPO: edwinumana/task-manager
  PYTHON_VERSION: '3.9'

jobs:
  # =============================================================================
  # JOB 1: TESTING
  # =============================================================================
  test:
    name: ğŸ§ª Testing & Quality Checks
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        test-type: [unit, integration, core]
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('task_manager/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ğŸ”§ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          default-libmysqlclient-dev \
          pkg-config \
          build-essential
          
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        cd task_manager
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-xdist  # Para tests paralelos
        
    - name: ğŸ§ª Run Tests - ${{ matrix.test-type }}
      run: |
        cd task_manager
        case "${{ matrix.test-type }}" in
          "unit")
            python -m pytest tests/ -m "unit" -v --tb=short
            ;;
          "integration")
            python -m pytest tests/ -m "integration" -v --tb=short
            ;;
          "core")
            python -m pytest tests/test_core_isolated.py tests/test_simple.py -v --tb=short
            ;;
        esac
        
    - name: ğŸ“Š Generate Coverage Report
      if: matrix.test-type == 'unit'
      run: |
        cd task_manager
        python -m pytest tests/ -m "unit" --cov=app --cov-report=html --cov-report=xml
        
    - name: ğŸ“¤ Upload Coverage to Artifacts
      if: matrix.test-type == 'unit'
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: task_manager/htmlcov/
        
    - name: ğŸ” Code Quality Check
      if: matrix.test-type == 'unit'
      run: |
        cd task_manager
        # Verificar que la aplicaciÃ³n se puede importar
        python -c "from app import create_app; print('âœ… Application imports successfully')"

  # =============================================================================
  # JOB 2: BUILD
  # =============================================================================
  build:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”§ Build Docker Image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE }}:latest .
        docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
        
    - name: ğŸ§ª Test Docker Image
      run: |
        # Iniciar contenedor en background
        docker run -d --name test-container -p 5000:5000 ${{ env.DOCKER_IMAGE }}:latest
        
        # Esperar a que el servicio estÃ© listo
        timeout=30
        while [ $timeout -gt 0 ]; do
          if curl -f http://localhost:5000/tasks >/dev/null 2>&1; then
            echo "âœ… Application is responding"
            break
          fi
          echo "â³ Waiting for application to start... ($timeout seconds left)"
          sleep 2
          timeout=$((timeout-2))
        done
        
        if [ $timeout -le 0 ]; then
          echo "âŒ Application failed to start"
          docker logs test-container
          exit 1
        fi
        
        # Probar endpoints principales
        curl -f http://localhost:5000/tasks || exit 1
        curl -f http://localhost:5000/user-stories || exit 1
        
        # Limpiar
        docker stop test-container
        docker rm test-container
        
    - name: ğŸ’¾ Save Docker Image
      run: |
        docker save ${{ env.DOCKER_IMAGE }}:latest | gzip > docker-image.tar.gz
        
    - name: ğŸ“¤ Upload Docker Image Artifact
      uses: actions/upload-artifact@v3
      with:
        name: docker-image
        path: docker-image.tar.gz
        retention-days: 1

  # =============================================================================
  # JOB 3: PUSH TO DOCKER HUB
  # =============================================================================
  push:
    name: ğŸš€ Push to Docker Hub
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Docker Image
      uses: actions/download-artifact@v3
      with:
        name: docker-image
        
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: ğŸ”§ Load and Tag Docker Image
      run: |
        gunzip -c docker-image.tar.gz | docker load
        
        # Crear tags mÃºltiples
        docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_HUB_REPO }}:latest
        docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_HUB_REPO }}:${{ github.sha }}
        docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_HUB_REPO }}:v${{ github.run_number }}
        
    - name: ğŸš€ Push to Docker Hub
      run: |
        docker push ${{ env.DOCKER_HUB_REPO }}:latest
        docker push ${{ env.DOCKER_HUB_REPO }}:${{ github.sha }}
        docker push ${{ env.DOCKER_HUB_REPO }}:v${{ github.run_number }}
        
    - name: ğŸ“ Generate Docker Hub URL
      run: |
        echo "ğŸ³ Docker image pushed successfully!"
        echo "ğŸ“¦ Available at: https://hub.docker.com/r/${{ env.DOCKER_HUB_REPO }}"
        echo "ğŸ·ï¸ Tags: latest, ${{ github.sha }}, v${{ github.run_number }}"

  # =============================================================================
  # JOB 4: DEPLOYMENT VERIFICATION
  # =============================================================================
  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: push
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ³ Pull and Test Image from Docker Hub
      run: |
        # Esperar un poco para que la imagen estÃ© disponible
        sleep 30
        
        # Descargar imagen desde Docker Hub
        docker pull ${{ env.DOCKER_HUB_REPO }}:latest
        
        # Iniciar contenedor
        docker run -d --name verify-container -p 5000:5000 ${{ env.DOCKER_HUB_REPO }}:latest
        
        # Esperar a que el servicio estÃ© listo
        timeout=60
        while [ $timeout -gt 0 ]; do
          if curl -f http://localhost:5000/tasks >/dev/null 2>&1; then
            echo "âœ… Deployment verification successful"
            break
          fi
          echo "â³ Waiting for service... ($timeout seconds left)"
          sleep 3
          timeout=$((timeout-3))
        done
        
        if [ $timeout -le 0 ]; then
          echo "âŒ Deployment verification failed"
          docker logs verify-container
          exit 1
        fi
        
        # Probar endpoints principales
        curl -f http://localhost:5000/tasks
        curl -f http://localhost:5000/user-stories
        
        # Limpiar
        docker stop verify-container
        docker rm verify-container
        
    - name: ğŸ‰ Deployment Success
      run: |
        echo "ğŸ‰ Pipeline completed successfully!"
        echo "âœ… Tests passed"
        echo "âœ… Docker image built"
        echo "âœ… Image pushed to Docker Hub"
        echo "âœ… Deployment verified"
        echo ""
        echo "ğŸš€ Your application is ready!"
        echo "ğŸ“¦ Docker Hub: https://hub.docker.com/r/${{ env.DOCKER_HUB_REPO }}"
        echo "ğŸ³ Run with: docker run -p 5000:5000 ${{ env.DOCKER_HUB_REPO }}:latest" 